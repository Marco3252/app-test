<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Diario Pedagogico</title>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
    }

    body {
        height: 100vh;
        overflow-x: hidden;
        background: #f0fdf4;
    }

    /* ===== HEADER ===== */
    .header {
        height: 56px;
        background: #166534;
        color: white;
        display: flex;
        align-items: center;
        padding: 0 15px;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 900;
    }

    .header h1 {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        font-size: 18px;
        font-weight: normal;
    }

    .menu-btn {
        font-size: 24px;
        cursor: pointer;
        background: none;
        border: none;
        color: white;
    }

    /* ===== OVERLAY ===== */
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.4);
        display: none;
        z-index: 950;
    }

    .overlay.show {
        display: block;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 240px;
        height: 100%;
        background: #14532d;
        color: #fff;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        padding-top: 10px;
        z-index: 1000;
    }

    .sidebar.show {
        transform: translateX(0);
    }

    .sidebar .menu-btn {
        display: block;
        margin-left: auto;
        margin-right: 15px;
        margin-bottom: 10px;
    }

    .sidebar h2 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 18px;
    }

    .menu {
        list-style: none;
    }

    .menu li {
        padding: 15px 20px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .menu li:hover {
        background: #22c55e;
        color: #14532d;
        font-weight: bold;
    }

    /* ===== CONTENT ===== */
    .content {
        padding: 80px 20px 20px;
        min-height: 100vh;
    }
</style>

</head>

<body>

<!-- HEADER -->
<div class="header">
    <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
    <h1 id="titulo">Escanear Qr</h1>
</div>

<!-- OVERLAY -->
<div class="overlay" id="overlay" onclick="closeMenu()"></div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
    <button class="menu-btn" onclick="closeMenu()">‚ò∞</button>

    <h2>Men√∫</h2>
    <ul class="menu">
        <li onclick="window.location.href='index.html'">üìã Marcar asistencia</li>
        <li onclick="window.location.href='Salida.html'">üì§ Solicitar salida</li>
        <li onclick="window.location.href='pendiente.html'">üì¶ Salidas pendientes</li>
        <li>üìÅ Ver expediente</li>
        <li onclick="window.location.href='CalificarClase.html'">üìù Calificar clase</li>
    </ul>
</div>

<script>
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");

    function toggleMenu() {
        sidebar.classList.toggle("show");
        overlay.classList.toggle("show");
    }

    function closeMenu() {
        sidebar.classList.remove("show");
        overlay.classList.remove("show");
    }

    /* ===== GESTO DESLIZAR ===== */
    let startX = 0;

    sidebar.addEventListener("touchstart", e => {
        startX = e.touches[0].clientX;
    });

    sidebar.addEventListener("touchend", e => {
        const endX = e.changedTouches[0].clientX;
        if (startX - endX > 50) {
            closeMenu();
        }
    });
</script>



<!-- CONTENT -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
:root{
  --primary:#2563eb;
  --danger:#dc2626;
  --bg:#0f172a;
}

body{
  margin:0;
  font-family: system-ui, sans-serif;
  background:#f1f5f9;
}

header{
  background:var(--bg);
  color:white;
  padding:14px;
  text-align:center;
  font-size:18px;
}

/* CONTENEDOR */
.main{
  max-width:500px;
  margin:auto;
  padding:15px;
}

/* CUADRO CAMARA */
.camera-box{
  position:relative;
  width:100%;
  min-height:260px;
  border-radius:14px;
  overflow:hidden;
  background:#111827;
}

#reader{
  width:100%;
  height:100%;
}

/* ESTADO INACTIVO */
.camera-box.inactive::after{
  content:"";
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.55);
  z-index:2;
}

.qr-placeholder{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:3;
  color:white;
  font-size:80px;
  opacity:.9;
}

/* MARCO QR ACTIVO */
.qr-frame{
  position:absolute;
  inset:20%;
  z-index:3;
  display:none;
}

.qr-frame span{
  position:absolute;
  width:30px;
  height:30px;
  border:4px solid #ffffff;
}

.qr-frame .tl{ top:0; left:0; border-right:none; border-bottom:none; }
.qr-frame .tr{ top:0; right:0; border-left:none; border-bottom:none; }
.qr-frame .bl{ bottom:0; left:0; border-right:none; border-top:none; }
.qr-frame .br{ bottom:0; right:0; border-left:none; border-top:none; }

/* BOTONES */
.controls{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top:15px;
}

button{
  padding:12px 16px;
  border:none;
  border-radius:10px;
  font-size:15px;
  cursor:pointer;
}

.primary{ background:var(--primary); color:white; }
.danger{ background:var(--danger); color:white; }
.gray{ background:#64748b; color:white; }

/* MODALES */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;

  padding:14px; /* üëà margen para tel√©fono */
  box-sizing:border-box;
}

.modal{
  background:white;
  width:92%;
  max-width:420px;
  border-radius:14px;
  padding:16px;
}

.modal img{
  width:100px;
  display:block;
  margin:10px auto;
}

.modal p{
  text-align:center;
}

.modal-buttons{
  display:flex;
  justify-content:space-between;
  gap:10px;
  margin-top:15px;
}

/* LISTA CURSOS */
.course-list{
  max-height:250px;
  overflow-y:auto;
}

.course-item{
  padding:12px;
  border-bottom:1px solid #e5e7eb;
  cursor:pointer;
}

.course-item.active{
  background:#dbeafe;
}
/* üîß ELIMINA DECORACIONES INTERNAS DE html5-qrcode */
#reader * {
  box-shadow: none !important;
  border: none !important;
  outline: none !important;
}

/* Evita marcos blancos internos */
#reader canvas,
#reader video {
  background: transparent !important;
}

/* Asegura que SOLO se vea tu marco azul */
.qr-frame {
  pointer-events: none;
}

</style>
<style>
/* Estilo para fijar el buscador abajo */ 
.buscador-fijo { 
  position: fixed; 
  bottom: 0; 
  left: 0; 
  width: 100%; 
  background: #fff; 
  /* color de fondo para que no se superponga visualmente */ 
  z-index: 1; 
  /* mayor que el contenido, menor que tu men√∫ si este es fijo */ 
  box-shadow: 0 -2px 5px rgba(0,0,0,0.1); 
  /* sombra opcional */ 
}
  .form-control-borderless {
    border: none;
}

.form-control-borderless:hover, .form-control-borderless:active, .form-control-borderless:focus {
    border: none;
    outline: none;
    box-shadow: none;
}
.buscador-fijo{
    padding-left:0 !important;
    padding-right:0 !important;
}
</style>
</head>

<body>

<header>Registro de Asistencia</header>

<div class="main">

  <div class="camera-box inactive" id="cameraBox">
    <div id="reader"></div>

    <!-- ICONO QR -->
    <div class="qr-placeholder" id="qrPlaceholder">‚åÅ</div>

    <!-- MARCO -->
    <div class="qr-frame" id="qrFrame">
      <span class="tl"></span>
      <span class="tr"></span>
      <span class="bl"></span>
      <span class="br"></span>
    </div>
  </div>

  <div class="controls">
    <button id="scanBtn" class="primary">Escanear</button>
    <button id="camBtn" class="gray">Elegir c√°mara</button>
  </div>

</div>

<!-- MODAL PRINCIPAL -->
<div class="overlay" id="modalMain">
  <div class="modal">
    <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" id="QrAlumnoImagen">
    <p id="qrText"></p>
    <p id="courseText"></p>

    <div class="modal-buttons">
        <button id="registerBtn" class="primary">Registrar</button>
        <button id="changeCourseBtn" class="gray">Ver otro curso</button>
        <button id="denyBtn" class="danger">No permitir</button>
    </div>
  </div>
</div>

<!-- MODAL CURSOS -->
<div class="overlay" id="modalCourses">
  <div class="modal">
    <h3>Seleccionar curso</h3>
    <div class="course-list" id="courseList"></div>
    <div class="modal-buttons">
        <button id="acceptCourse" class="primary">Aceptar</button>
        <button id="cancelCourse" class="danger">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL CAMARAS -->
<div class="overlay" id="modalCameras">
  <div class="modal">
    <h3>C√°maras disponibles</h3>
    <div id="cameraList"></div>
  </div>
</div>

<!------ Include the above in your HEAD tag ---------->

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
    <br/>
  
  <div class="container-fluid buscador-fijo"> 
    <form id="buscadorForm"> 
      <label>Buscar alumno por ID</label> 
      <div class="input-group"> 
        <i class="fas fa-search"></i> 
        <input type="search" placeholder="Buscar por ID" id="alumnoInput"> 
      </div> 
      <button type="submit">Search</button> 
    </form> 
  </div>

<style>
  .buscador-fijo form { margin: 0 20px; /* margen solo a los lados */ }
   .buscador-fijo {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #fff;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      padding: 20px; /* margen interno */
      z-index: 1;
    }

    .buscador-fijo label {
      font-size: 1.3rem; /* label m√°s grande */
      font-weight: bold;
      margin-bottom: 15px;
      display: block;
      text-align: center;
    }

    .buscador-fijo .input-group {
      display: flex;       /* icono + input en l√≠nea */
      align-items: center;
      margin-bottom: 15px;
    }

    .buscador-fijo i {
      font-size: 22px;
      color: #333;
      margin-right: 10px;  /* separaci√≥n respecto al input */
    }

    .buscador-fijo input {
      flex: 1;             /* que el input ocupe todo el espacio restante */
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .buscador-fijo button {
      display: block;
      width: 100%;
      padding: 12px;
      font-size: 1.1rem;
      color: #fff;
      background-color: #28a745; /* verde */
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .buscador-fijo button:hover {
      background-color: #218838;
    }
</style>
<script>
  // Capturar el submit del formulario
  document.getElementById('buscadorForm').addEventListener('submit', function(e){
    e.preventDefault(); // evitar recarga de p√°gina

    const alumnoId = document.getElementById('alumnoInput').value.trim();

    // calcular fecha de ma√±ana
    let hoy = new Date();
    let manana = new Date(hoy);
    manana.setDate(hoy.getDate() + 1);

    // convertir a formato YYYY-MM-DD
    let fechaStr = manana.toISOString().split('T')[0];

    // construir el texto id|fecha
    let text = alumnoId + "|" + fechaStr;

    // llamar a tu funci√≥n
    onScan(text);
  });
let scanner;
let scanning=false;
let selectedCamera=null;
let selectedCourseIndex=0;

window.cursos=[];
let alumnoIdActual = null;

function cambiarImagenSiExiste(url) { 
  let imgTest = new Image(); 
  
  imgTest.onload = function() { 
    // Si la imagen se carg√≥ bien, reemplaza el src 
    document.getElementById("QrAlumnoImagen").src = url; 
  }; 
  
  imgTest.onerror = function() { 
    // Si falla, no se cambia nada 
    console.log("La imagen no existe, se mantiene la actual"); 
  }; 
  
  imgTest.src = url; 
}

  const scanBtn=document.getElementById("scanBtn");
const cameraBox=document.getElementById("cameraBox");
const qrPlaceholder=document.getElementById("qrPlaceholder");
const qrFrame=document.getElementById("qrFrame");

scanBtn.onclick=async()=>{
  if(!scanning){
    scanner=new Html5Qrcode("reader");
    const cams=await Html5Qrcode.getCameras();
    selectedCamera=selectedCamera||cams[0].id;

    cameraBox.classList.remove("inactive");
    qrPlaceholder.style.display="none";
    qrFrame.style.display="block";

    scanner.start(selectedCamera,{fps:10,qrbox:250},onScan);
    scanBtn.textContent="Detener";
    scanning=true;
  }else{
    stopScanner();
  }
};

function stopScanner(){
  if(scanner){
    scanner.stop();
    scanning=false;
    scanBtn.textContent="Escanear";
    cameraBox.classList.add("inactive");
    qrPlaceholder.style.display="flex";
    qrFrame.style.display="none";
  }
}

function onScan(text){
  stopScanner();
  
  // RESET TOTAL DEL ESTADO
  cursos = [];
  selectedCourseIndex = 0;

  let partes = text.split("|");
  let hoy = new Date(); // fecha actual 
  let expiraDate = new Date(partes[1]); // convertir string a Date 
  const alumnoId = partes[0]; // obtener ID del alumno
  alumnoIdActual = alumnoId;

  if (expiraDate < hoy) { 
    alert("La fecha ya expir√≥"); 
    return;
  }

  if (!alumnoId) {
    alert('‚ùå No se encontr√≥ el ID del alumno');
    return;
  }

  console.log('üîç Buscando alumno con ID:', alumnoId);
  const formData = new FormData();
  formData.append('Action', 'ObtenerAlumno');
  formData.append('AlumnoId', alumnoId);
/* Consulta A_01 => Obtener alumno por id */
  fetch('FSMA_API_AppView.php', {
    method: 'POST',
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
        qrText.textContent=data.data.NombreAlumno + " " + data.data.ApellidoAlumno;
        cambiarImagenSiExiste("../DB/ImgBase/StudentImg/" + data.data.UrlFoto);
    } else {
      console.error(data.message);
    }
  })
  .catch(err => console.error('ERROR FETCH:', err));
  

const formData2 = new FormData();
formData2.append('Action', 'CursosAlumno');
formData2.append('AlumnoId', alumnoId);
/* Consulta A_02 => Obtener cursos inscritos del alumno */
fetch('FSMA_API_AppView.php', {
  method: 'POST',
  body: formData2
})
.then(res => res.json())
.then(data => {
  if (data.success) {
    //console.log('üìö Cursos del alumno:', data.data);
    // data.data[0] ser√° el curso activo (si existe)
    data.data.forEach(curso => {
      cursos.push({
        id: curso.Id,
        nombre: curso.NombreCurso
      });
    });
    //console.log('üìö Cursos del alumno:', cursos);
    updateCourseText();
    modalMain.style.display="flex";

    changeCourseBtn.style.display=cursos.length>1?"block":"none";
    registerBtn.style.display=cursos.length>0?"block":"none";
  } else {
    console.error('‚ùå', data.message);
  }
})
.catch(err => console.error('üî• ERROR:', err));

}

function updateCourseText(){
  courseText.textContent=cursos.length
    ? `Este alumno est√° ingresando al curso: "${cursos[0].nombre}"`
    : "No hay cursos disponibles";
}

denyBtn.onclick=()=>{
  modalMain.style.display="none";
  cambiarImagenSiExiste("../DB/ImgBase/System/avatar.png");
  qrText.textContent= "";
};

registerBtn.onclick=()=>{
  //alert("Registrado ‚úî");
  const cursoSeleccionado = cursos[0]; // siempre el activo

  registrarAsistencia(
    alumnoIdActual,
    cursoSeleccionado.id
  );

  modalMain.style.display = "none";
  cambiarImagenSiExiste("../DB/ImgBase/System/avatar.png");
  qrText.textContent= "";
};

changeCourseBtn.onclick=()=>{
  modalCourses.style.display="flex";
  loadCourses();
};

function loadCourses(){
  courseList.innerHTML="";
  cursos.forEach((c,i)=>{
    const d=document.createElement("div");
    d.className="course-item"+(i===selectedCourseIndex?" active":"");
    d.textContent = c.nombre;
    d.onclick=()=>{
      document.querySelectorAll(".course-item").forEach(x=>x.classList.remove("active"));
      d.classList.add("active");
      selectedCourseIndex=i;
    };
    courseList.appendChild(d);
  });
}

acceptCourse.onclick=()=>{
  if(selectedCourseIndex!==0){
    [cursos[0],cursos[selectedCourseIndex]]=[cursos[selectedCourseIndex],cursos[0]];
  }
  modalCourses.style.display="none";
  updateCourseText();
};

cancelCourse.onclick=()=>modalCourses.style.display="none";

camBtn.onclick=async()=>{
  modalCameras.style.display="flex";
  cameraList.innerHTML="";
  const cams=await Html5Qrcode.getCameras();
  cams.forEach(c=>{
    const b=document.createElement("button");
    b.style.margin="5px";
    b.textContent=c.label||"C√°mara";
    b.onclick=()=>{
      selectedCamera=c.id;
      modalCameras.style.display="none";
    };
    cameraList.appendChild(b);
  });
};

function registrarAsistencia(alumnoId, cursoId, force = false) {

  const formData = new FormData();
  formData.append("Action", "NuevaAsistencia");
  formData.append("AlumnoId", alumnoId);
  formData.append("CursoId", cursoId);
  if (force) formData.append("ForceOverwrite", 1);

  fetch("FSMA_API_AppView.php", {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(data => {

    console.log(data);

    if (data.needs_confirm) {
      if (confirm("Ya se registr√≥ la salida ¬øDesea sobreescribirla?")) {
        registrarAsistencia(alumnoId, cursoId, true);
      }
      return;
    }

    //alert("‚úî Asistencia registrada");

  })
  .catch(err => {
    console.error("Error:", err);
    alert("Error de comunicaci√≥n");
  });
}


</script>


</body>
</html>



